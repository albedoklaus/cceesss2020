on: [push]


env:
  COLLAB_USER: Xerox16
  COLLAB_REPO: CCEES-Exercises
  COLLAB_DEPLOY_KEY: ${{ secrets.COLLAB_DEPLOY_KEY }}

jobs:
  collab:
    if: "contains(github.event.head_commit.message, '[collab]')"
    runs-on: ubuntu-latest
    container:
      image: debian:buster
    steps:
      - name: Install dependencies
        run: |
          apt update
          apt install -y git python3 wordnet
      - name: Clone collab repo
        run: |
          private_key="$(pwd)/id_ed25519"
          printf '%s\n' "$COLLAB_DEPLOY_KEY" | base64 --decode > "$private_key"
          md5sum "$private_key"
          chmod 600 "$private_key"
          export GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no -i \"$private_key\""
          git clone "git@github.com:$COLLAB_USER/$COLLAB_REPO.git"
          git clone "git@github.com:$GITHUB_REPOSITORY.git"
          find .
      - name: Generate operation name
        run: |
          python3 - << EOF
          import hashlib
          import os
          import secrets
          def index(filename):
              result = []
              with open(filename) as fh:
                  for line in fh:
                      if line.startswith(" "):
                          continue
                      lemma, _, synset_cnt, *_ = line.split()
                      if not 4 < len(lemma) < 10:
                          continue
                      if not lemma.isalpha():
                          continue
                      if int(synset_cnt) > 2:
                          result.append(lemma)
              return result
          def word(string, words):
              hash = hashlib.sha256(string.encode())
              number = int(hash.hexdigest(), 16) % len(words)
              return words[number]
          nouns = index("/usr/share/wordnet/index.noun")
          adjectives = index("/usr/share/wordnet/index.adj")
          for folder in os.listdir(os.environ["COLLAB_REPO"]):
              if folder.startswith("."):
                  continue
              folder = os.path.join(os.environ["COLLAB_REPO"], folder)
              if not os.path.isdir(folder):
                  continue
              word1 = word("word1_" + folder, nouns).capitalize()
              word2 = word("word2_" + folder, nouns).capitalize()
              print(folder, "->", "Operation", word1, word2)
          EOF
